<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Simulation Euro Millions</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 10px;
    }
    .left-column {
      flex: 1;
      max-width: 45%;
      text-align: left;
    }
    .right-column {
      flex: 1;
      max-width: 45%;
      text-align: left;
    }
    .form-group,
    .display,
    .compteur {
      font-size: 1.1em;
      margin: 10px 0;
    }
    input,
    button,
    select,
    textarea {
      padding: 6px 12px;
      font-size: 1em;
      margin: 5px;
    }
    .ticket {
      border: 1px solid #aaa;
      padding: 8px;
      margin: 5px 0;
      width: fit-content;
    }
    .winning {
      background-color: #cfc;
    }
    #chanceDisplay {
      font-weight: bold;
      margin: 10px 0;
    }
    #resultat {
      border: 2px solid gold;
      padding: 10px;
      margin: 10px 0;
    }
    /* Un petit style pour la liste des stats */
    #statsContainer {
      margin-top: 20px;
    }
    #statsContainer ul {
      list-style: none;
      padding: 0;
    }
    #statsContainer li {
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Colonne de gauche : paramètres et boutons -->
    <div class="left-column">
      <h1>Simulation Euro Millions</h1>
      <div class="section">
        <div class="form-group">
          <label for="modeSelect">Mode :</label>
          <select id="modeSelect">
            <option value="flash" selected>Flash (tickets aléatoires)</option>
            <option value="custom">Personnalisé (définir mes propres grilles)</option>
          </select>
        </div>
        <div class="form-group" id="flashSettings">
          <label for="ticketNumbersCount">Nombre de numéros (min 5, max 50) :</label>
          <input type="number" id="ticketNumbersCount" value="5" min="5" max="50"><br>
          <label for="ticketStarsCount">Nombre d'étoiles (min 2, max 12) :</label>
          <input type="number" id="ticketStarsCount" value="2" min="2" max="12">
        </div>
        <div class="form-group" id="customSettings" style="display:none;">
          <label for="customGrids">
            Mes grilles personnalisées :<br>
            Entrez une grille par ligne au format "num1,num2,... ; star1,star2,..."<br>
            Exemple: <em>3,15,22,37,42 ; 1,9</em>
          </label>
          <br>
          <textarea id="customGrids" rows="4" cols="50" placeholder="Une grille par ligne"></textarea>
        </div>
        <div class="form-group" id="ticketsCountGroup">
          <label for="numTickets">Nombre de tickets par tirage :</label>
          <input type="number" id="numTickets" value="2" min="1">
        </div>
        <div class="form-group">
          <label for="stopNumbers">Stopper si au moins X numéros corrects :</label>
          <input type="number" id="stopNumbers" value="5" min="1" max="5">
        </div>
        <div class="form-group">
          <label for="stopStars">Stopper si au moins Y étoiles correctes :</label>
          <input type="number" id="stopStars" value="2" min="1" max="2">
        </div>
        <div class="form-group" id="batchSizeGroup">
          <label for="batchSize">Tirage par ms :</label>
          <input type="number" id="batchSize" value="1000" min="1">
        </div>
        <div class="form-group">
          <label for="speed">Vitesse (ms) :</label>
          <input type="number" id="speed" value="1" min="0">
        </div>
        <button id="startBtn">Démarrer la simulation</button>
        <button id="stopBtn">Stop</button>
        <button id="resetBtn">Reset</button>
      </div>
    </div>

    <!-- Colonne de droite : affichage des chances, tickets, résultats, compteur, stats -->
    <div class="right-column">
      <div id="chanceDisplay"></div>
      <div class="section display" id="resultat">
        <strong>Tirage :</strong><br>
        Numéros : --<br>
        Étoiles : --
      </div>
      <div class="compteur" id="counter">Tirages : 0</div>

      <div class="section display" id="ticketsContainer"></div>

      <!-- Nouveau bloc pour les statistiques de combinaisons -->
      <div class="section display" id="statsContainer">
        <h3>Statistiques de résultats</h3>
        <ul>
          <!-- On n'affiche que les combos souhaitées -->
          <li>5 n° + 2 ★ : <span id="stats_5_2">0</span></li>
          <li>5 n° + 1 ★ : <span id="stats_5_1">0</span></li>
          <li>4 n° + 2 ★ : <span id="stats_4_2">0</span></li>
          <li>4 n° + 1 ★ : <span id="stats_4_1">0</span></li>
          <li>3 n° + 2 ★ : <span id="stats_3_2">0</span></li>
          <li>3 n° + 1 ★ : <span id="stats_3_1">0</span></li>
          <li>2 n° + 2 ★ : <span id="stats_2_2">0</span></li>
          <li>2 n° + 1 ★ : <span id="stats_2_1">0</span></li>
          <li>1 n° + 2 ★ : <span id="stats_1_2">0</span></li>
          <li>1 n° + 1 ★ : <span id="stats_1_1">0</span></li>
          <li>0 n° + 2 ★ : <span id="stats_0_2">0</span></li>
          <li>0 n° + 1 ★ : <span id="stats_0_1">0</span></li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    // --- VARIABLES GLOBALES ---

    // 1) Objet pour stocker les occurrences de chaque combinaison (numéros/stars)
    //    On reprend les combinaisons voulues (5-2, 5-1, etc.).
    let stats = {
      "5_2": 0,
      "5_1": 0,
      "4_2": 0,
      "4_1": 0,
      "3_2": 0,
      "3_1": 0,
      "2_2": 0,
      "2_1": 0,
      "1_2": 0,
      "1_1": 0,
      "0_2": 0,
      "0_1": 0
    };

    let count = 0;         // compteur de tirages
    let stopFlag = false;  // flag pour stopper la simulation
    let loopTimeout;       // ID du timeout de la boucle

    // --- FONCTIONS UTILES ---

    function combination(n, r) {
      if (r > n) return 0;
      let num = 1, den = 1;
      for (let i = 0; i < r; i++) {
        num *= (n - i);
        den *= (i + 1);
      }
      return num / den;
    }

    function generateNumbers(count, max) {
      let numbers = [];
      while (numbers.length < count) {
        const num = Math.floor(Math.random() * max) + 1;
        if (!numbers.includes(num)) {
          numbers.push(num);
        }
      }
      return numbers.sort((a, b) => a - b);
    }

    function generateTicket(numCount, starCount) {
      const ticketNumbers = generateNumbers(numCount, 50);
      const ticketStars = generateNumbers(starCount, 12);
      return { numbers: ticketNumbers, stars: ticketStars };
    }

    function generateDraw() {
      const drawNumbers = generateNumbers(5, 50);
      const drawStars = generateNumbers(2, 12);
      return { numbers: drawNumbers, stars: drawStars };
    }

    function countMatches(arr1, arr2) {
      return arr1.filter(x => arr2.includes(x)).length;
    }

    function parseCustomInput(str) {
      return str.split(',')
                .map(s => parseInt(s.trim()))
                .filter(n => !isNaN(n));
    }

    function parseCustomGrids(str) {
      const lines = str.split('\n').filter(line => line.trim() !== '');
      const tickets = [];
      lines.forEach(line => {
        const parts = line.split(';');
        if (parts.length === 2) {
          const numbers = parseCustomInput(parts[0]);
          const stars = parseCustomInput(parts[1]);
          if (numbers.length > 0 && stars.length > 0) {
            tickets.push({ numbers: numbers.sort((a, b) => a - b), stars: stars.sort((a, b) => a - b) });
          }
        }
      });
      return tickets;
    }

    // 2) Met à jour l’affichage des stats dans la partie HTML (dans #statsContainer)
	function updateStatsDisplay() {
	  // 1) Calcule la somme totale de toutes les occurrences
	  let total = 0;
	  for (let combo in stats) {
		total += stats[combo];
	  }

	  // 2) Pour chaque combinaison, calcule le pourcentage
	  for (let combo in stats) {
		const elem = document.getElementById("stats_" + combo);
		if (elem) {
		  const count = stats[combo];
		  // Évite la division par zéro
		  let pct = (total > 0) ? (count / total * 100) : 0;

		  // 3) Affiche, par exemple : "163 (0.24%)"
		  //    On peut utiliser .toFixed(2) pour 2 décimales, 
		  //    et toLocaleString('de-DE') pour formater le nombre d'occurrences avec des points.
		  elem.innerHTML = `
		  ${count.toLocaleString('de-DE')} 
		  <span style="color: gray;">(${pct.toFixed(2)}%)</span>
		`;
		}
	  }
	}


    // Calcul et affichage du taux de chance estimé
    function updateChanceDisplay() {
      const mode = document.getElementById("modeSelect").value;
      let numCount, starCount;

      if (mode === "flash") {
        numCount = parseInt(document.getElementById("ticketNumbersCount").value) || 5;
        starCount = parseInt(document.getElementById("ticketStarsCount").value) || 2;
      } else {
        const customGridsText = document.getElementById("customGrids").value;
        const grids = parseCustomGrids(customGridsText);
        if (grids.length > 0) {
          numCount = grids[0].numbers.length;
          starCount = grids[0].stars.length;
        } else {
          // Si pas de grilles valides, on peut forcer 5 et 2 ou laisser un fallback
          numCount = 5;
          starCount = 2;
        }
      }

      const numTickets = (mode === "flash")
        ? (parseInt(document.getElementById("numTickets").value) || 1)
        : 1;

      const stopNumbers = parseInt(document.getElementById("stopNumbers").value) || 5;
      const stopStars = parseInt(document.getElementById("stopStars").value) || 2;

      function computeChance(numCount, starCount, stopNumbers, stopStars) {
        let probNum = 0;
        for (let k = stopNumbers; k <= Math.min(numCount, 5); k++) {
          probNum += combination(numCount, k) *
                     combination(50 - numCount, 5 - k) /
                     combination(50, 5);
        }
        let probStars = 0;
        for (let l = stopStars; l <= Math.min(starCount, 2); l++) {
          probStars += combination(starCount, l) *
                       combination(12 - starCount, 2 - l) /
                       combination(12, 2);
        }
        return probNum * probStars;
      }

      const pTicket = computeChance(numCount, starCount, stopNumbers, stopStars);
      const pGlobal = 1 - Math.pow(1 - pTicket, numTickets);
      const percent = (pGlobal * 100).toFixed(8);
      const reciprocalFormatted = pGlobal > 0
        ? (1 / pGlobal).toLocaleString('de-DE', { maximumFractionDigits: 0 })
        : "∞";

      document.getElementById("chanceDisplay").innerHTML =
        `Taux de chance (pour au moins ${stopNumbers} n° et ${stopStars} ★) : ${percent}%<br>` +
        `1 chance sur ${reciprocalFormatted}`;
    }

    // --- EVENEMENTS ET BOUCLE PRINCIPALE ---

    document.querySelectorAll("#ticketNumbersCount, #ticketStarsCount, #numTickets, #stopNumbers, #stopStars, #customGrids, #batchSize")
      .forEach(input => {
        input.addEventListener("input", updateChanceDisplay);
      });
    updateChanceDisplay();

    document.getElementById("stopBtn").style.display = "none";

    document.getElementById("modeSelect").addEventListener("change", function() {
      const mode = this.value;
      if (mode === "flash") {
        document.getElementById("flashSettings").style.display = "block";
        document.getElementById("customSettings").style.display = "none";
        document.getElementById("ticketsCountGroup").style.display = "block";
        document.getElementById("batchSizeGroup").style.display = "block";
      } else {
        document.getElementById("flashSettings").style.display = "none";
        document.getElementById("customSettings").style.display = "block";
        document.getElementById("ticketsCountGroup").style.display = "none";
        document.getElementById("batchSizeGroup").style.display = "block";
      }
      updateChanceDisplay();
    });

    function runLoop() {
      if (stopFlag) return;

      let tickets = [];
      let draw = null;
      const mode = document.getElementById("modeSelect").value;
      let customTickets = [];

      if (mode === "custom") {
        const customGridsText = document.getElementById("customGrids").value;
        customTickets = parseCustomGrids(customGridsText);
      }

      const numCount = (mode === "flash")
        ? (parseInt(document.getElementById("ticketNumbersCount").value) || 5)
        : (customTickets.length > 0
            ? customTickets[0].numbers.length
            : 5);

      const starCount = (mode === "flash")
        ? (parseInt(document.getElementById("ticketStarsCount").value) || 2)
        : (customTickets.length > 0
            ? customTickets[0].stars.length
            : 2);

      const numTickets = (mode === "flash")
        ? (parseInt(document.getElementById("numTickets").value) || 1)
        : (customTickets.length > 0 ? customTickets.length : 1);

      const stopNumbers = parseInt(document.getElementById("stopNumbers").value) || 5;
      const stopStars = parseInt(document.getElementById("stopStars").value) || 2;
      const speed = parseInt(document.getElementById("speed").value) || 0;
      const batchSize = parseInt(document.getElementById("batchSize").value) || 1000;

      for (let i = 0; i < batchSize; i++) {
        count++;
        tickets = [];

        // Génération des tickets (flash ou custom)
        for (let j = 0; j < numTickets; j++) {
          if (mode === "flash") {
            tickets.push(generateTicket(numCount, starCount));
          } else {
            if (customTickets.length > 0) {
              tickets.push(customTickets[j % customTickets.length]);
            }
          }
        }

        // Tirage
        draw = generateDraw();

        // Vérification des tickets
        let foundWinningTicket = false;
        tickets.forEach(ticket => {
          const matchNumbers = countMatches(ticket.numbers, draw.numbers);
          const matchStars = countMatches(ticket.stars, draw.stars);

          // 3) Incrémenter les stats (si la clé existe)
          const key = `${matchNumbers}_${matchStars}`;
          if (stats.hasOwnProperty(key)) {
            stats[key]++;
          }

          // On vérifie si on atteint le seuil stopNumbers / stopStars
          if (matchNumbers >= stopNumbers && matchStars >= stopStars) {
            foundWinningTicket = ticket;
          }
        });

        if (foundWinningTicket) {
          // Affiche la liste de tickets
          document.getElementById("ticketsContainer").innerHTML = "";
          tickets.forEach((ticket, index) => {
            const div = document.createElement("div");
            div.className = "ticket";
            const matchNumbers = countMatches(ticket.numbers, draw.numbers);
            const matchStars = countMatches(ticket.stars, draw.stars);
            div.innerHTML = `<strong>Ticket ${index + 1} :</strong><br>
                             Numéros : ${ticket.numbers.join(", ")}<br>
                             Étoiles : ${ticket.stars.join(", ")}<br>
                             (Correspondances : ${matchNumbers} n° et ${matchStars} ★)`;
            if (ticket === foundWinningTicket) {
              div.classList.add("winning");
            }
            document.getElementById("ticketsContainer").appendChild(div);
          });

          // Mise à jour du tirage
          document.getElementById("resultat").innerHTML =
            `<strong>Tirage :</strong><br>
             Numéros : ${draw.numbers.join(", ")}<br>
             Étoiles : ${draw.stars.join(", ")}`;

          document.getElementById("counter").textContent = "Tirages : " + count;

          // Mise à jour de l’affichage des stats
          updateStatsDisplay();

          alert(
            "Seuil atteint !\n" +
            "Ticket gagnant : " + foundWinningTicket.numbers.join(", ") + " | " + foundWinningTicket.stars.join(", ") + "\n" +
            "Tirage : " + draw.numbers.join(", ") + " | " + draw.stars.join(", ") + "\n" +
            "Nombre de tirages : " + count
          );
          stopFlag = true;
          document.getElementById("startBtn").style.display = "block";
          return;
        }
      }

      // Mise à jour de l’affichage après ce lot de tirages
      document.getElementById("ticketsContainer").innerHTML = "";
      tickets.forEach((ticket, index) => {
        const div = document.createElement("div");
        div.className = "ticket";
        div.innerHTML = `<strong>Ticket ${index + 1} :</strong><br>
                         Numéros : ${ticket.numbers.join(", ")}<br>
                         Étoiles : ${ticket.stars.join(", ")}`;
        document.getElementById("ticketsContainer").appendChild(div);
      });

      document.getElementById("resultat").innerHTML =
        `<strong>Tirage :</strong><br>
         Numéros : ${draw.numbers.join(", ")}<br>
         Étoiles : ${draw.stars.join(", ")}`;

      document.getElementById("counter").textContent = "Tirages : " + count.toLocaleString('de-DE');

      // 4) Mettre à jour l’affichage des stats à chaque batch
      updateStatsDisplay();

      loopTimeout = setTimeout(runLoop, speed);
    }

    function startDrawing() {
      clearTimeout(loopTimeout);
      count = 0;
      stopFlag = false;

      // Remise à zéro de stats
      for (let combo in stats) {
        stats[combo] = 0;
      }

      document.getElementById("counter").textContent = "Tirages : 0";
      document.getElementById("ticketsContainer").innerHTML = "";
      document.getElementById("resultat").innerHTML = `<strong>Tirage :</strong><br>Numéros : --<br>Étoiles : --`;
      document.getElementById("stopBtn").textContent = "Stop";

      // Mise à jour initiale des stats
      updateStatsDisplay();

      document.getElementById("startBtn").style.display = "none";
      document.getElementById("stopBtn").style.display = "inline-block";
      runLoop();
    }

    document.getElementById("startBtn").addEventListener("click", startDrawing);

    document.getElementById("stopBtn").addEventListener("click", function() {
      if (!stopFlag) {
        stopFlag = true;
        clearTimeout(loopTimeout);
        this.textContent = "Continuer";
      } else {
        stopFlag = false;
        this.textContent = "Stop";
        runLoop();
      }
    });

    document.getElementById("resetBtn").addEventListener("click", function() {
      stopFlag = true;
      clearTimeout(loopTimeout);
      count = 0;
      // Remise à zéro stats
      for (let combo in stats) {
        stats[combo] = 0;
      }
      updateStatsDisplay();

      document.getElementById("counter").textContent = "Tirages : 0";
      document.getElementById("ticketsContainer").innerHTML = "";
      document.getElementById("resultat").innerHTML =
        `<strong>Tirage :</strong><br>Numéros : --<br>Étoiles : --`;
      document.getElementById("stopBtn").textContent = "Stop";
      document.getElementById("startBtn").style.display = "block";
      document.getElementById("stopBtn").style.display = "none";
    });
  </script>
</body>
</html>
